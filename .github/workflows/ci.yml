name: ci

on:
  push:
      branches:
          - main
          - staging
  pull_request:
      branches:
          - main
          - staging

jobs:
  ci:
      runs-on: ${{ matrix.os }}

      strategy:
          matrix:
              os: [ubuntu-22.04]
              node: [14.17.0]

      steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: Setup node env
            uses: actions/setup-node@v4
            with:
                node-version: ${{ matrix.node }}

          - name: Install Yarn 1.22.22 manually
            run: |
              npm install -g yarn@1.22.22      

          - name: Install OpenSSL 1.1
            run: |
              sudo apt update
              sudo apt install -y wget
              wget http://old-releases.ubuntu.com/ubuntu/pool/main/o/openssl1.1/libssl1.1_1.1.1f-1ubuntu2_amd64.deb
              sudo dpkg -i libssl1.1_1.1.1f-1ubuntu2_amd64.deb
              export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu
              yarn prisma generate


          - name: Get yarn cache directory path
            id: yarn-cache-dir-path
            run: echo "dir=$(yarn cache dir)" >> $GITHUB_ENV

          - name: Cache node_modules
            uses: actions/cache@v4
            id: yarn-cache
            with:
                path: ${{ env.dir }}
                key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                restore-keys: |
                    ${{ runner.os }}-yarn-

          - name: Install dependencies
            run: yarn install --frozen-lockfile

          - name: Remove generated Prisma client
            run: rm -rf node_modules/@prisma node_modules/.prisma

          - name: Generate Prisma Client (avoid native in CI)
            run: npx prisma generate --schema=prisma/schema.prisma
  
          - name: Linting Prettier
            run: yarn lint:prettier

          - name: Linting ESlint
            run: yarn lint:eslint

          - name: Linting TypeScript
            run: yarn lint:tsc

          - name: Build
            run: yarn build
